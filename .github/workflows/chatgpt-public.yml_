name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Adjust based on your repo setup
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Temporary Directory
        run: mkdir -p /tmp/deploy

      - name: Clone Repository
        run: git clone . /tmp/deploy

      - name: Set Up Environment
        run: |
          cp .env.example .env  # Adjust based on your setup
          echo "MY_SECRET=${{ secrets.MY_SECRET }}" >> .env

      - name: Install Dependencies
        run: cd /tmp/deploy && pnpm install  # Adjust for npm/yarn if needed

      - name: Compile Code
        run: cd /tmp/deploy && pnpm run build  # Adjust if needed

      - name: Run Tests
        run: cd /tmp/deploy && pnpm test  # Adjust test command

      - name: Stop Application
        run: pm2 stop all || true  # Adjust for your process manager

      - name: Rename Original Folder
        run: mv /var/www/myapp /var/www/myapp_old || true  # Adjust path

      - name: Deploy New Version
        run: mv /tmp/deploy /var/www/myapp

      - name: Start Application
        run: pm2 restart all || pm2 start npm --name "myapp" -- run start  # Adjust

      - name: Clean Up Old Version
        run: rm -rf /var/www/myapp_old || true
